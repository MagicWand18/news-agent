generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  users     User[]
  clients   Client[]
}

model User {
  id             String         @id @default(cuid())
  name           String
  email          String?        @unique
  passwordHash   String?
  telegramUserId String?        @unique
  role           Role           @default(ANALYST)
  orgId          String
  org            Organization   @relation(fields: [orgId], references: [id])
  assignedTasks  Task[]
  notifications  Notification[]
  createdAt      DateTime       @default(now())
}

enum Role {
  ADMIN
  SUPERVISOR
  ANALYST
}

model Client {
  id              String          @id @default(cuid())
  name            String
  description     String?
  industry        String?
  telegramGroupId String?         // LEGACY: usar telegramRecipients
  clientGroupId   String?         // LEGACY: usar telegramRecipients
  active          Boolean         @default(true)
  orgId           String
  org             Organization    @relation(fields: [orgId], references: [id])
  keywords        Keyword[]
  mentions        Mention[]
  tasks           Task[]
  crisisAlerts    CrisisAlert[]
  reportLogs      ReportLog[]
  weeklyInsights  WeeklyInsight[]
  onboarding      Json?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Sprint 9: Múltiples destinatarios de Telegram
  telegramRecipients TelegramRecipient[]

  // Grounding Config - Configuración de búsqueda automática con Gemini
  groundingEnabled         Boolean   @default(false)  // Habilitar grounding automático
  minDailyMentions         Int       @default(3)      // Mínimo de menciones diarias esperadas
  consecutiveDaysThreshold Int       @default(3)      // Días consecutivos bajo umbral para disparar
  groundingArticleCount    Int       @default(10)     // Artículos a buscar en cada grounding
  weeklyGroundingEnabled   Boolean   @default(false)  // Habilitar grounding semanal programado
  weeklyGroundingDay       Int       @default(0)      // Día de la semana (0=domingo, 6=sábado)
  lastGroundingAt          DateTime?                  // Última ejecución de grounding
  lastGroundingResult      Json?                      // Resultado de la última búsqueda
}

model Keyword {
  id       String      @id @default(cuid())
  word     String
  type     KeywordType @default(NAME)
  clientId String
  client   Client      @relation(fields: [clientId], references: [id])
  active   Boolean     @default(true)

  @@unique([word, clientId])
}

enum KeywordType {
  NAME
  BRAND
  COMPETITOR
  TOPIC
  ALIAS
}

model Article {
  id          String    @id @default(cuid())
  url         String    @unique
  title       String
  source      String
  content     String?
  contentHash String?
  publishedAt DateTime?
  collectedAt DateTime  @default(now())
  mentions    Mention[]
}

model Mention {
  id             String    @id @default(cuid())
  articleId      String
  article        Article   @relation(fields: [articleId], references: [id])
  clientId       String
  client         Client    @relation(fields: [clientId], references: [id])
  keywordMatched String
  snippet        String?
  sentiment      Sentiment @default(NEUTRAL)
  relevance      Int       @default(5)
  aiSummary      String?
  aiAction       String?
  urgency        Urgency   @default(MEDIUM)
  notified       Boolean   @default(false)
  notifiedAt     DateTime?
  clientNotified Boolean   @default(false)
  createdAt      DateTime  @default(now())
  tasks          Task[]

  // Clustering
  parentMentionId String?
  parentMention   Mention?  @relation("MentionCluster", fields: [parentMentionId], references: [id])
  childMentions   Mention[] @relation("MentionCluster")
  clusterScore    Float?

  // Topic clustering (Sprint 6)
  topic          String?
  topicClusterId String?
  topicCluster   TopicCluster? @relation(fields: [topicClusterId], references: [id])

  @@index([clientId, createdAt])
  @@index([parentMentionId])
  @@index([clientId, parentMentionId, createdAt])
  @@index([topicClusterId])
}

enum Sentiment {
  POSITIVE
  NEGATIVE
  NEUTRAL
  MIXED
}

enum Urgency {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      TaskStatus @default(PENDING)
  priority    Priority   @default(MEDIUM)
  deadline    DateTime?
  clientId    String?
  client      Client?    @relation(fields: [clientId], references: [id])
  mentionId   String?
  mention     Mention?   @relation(fields: [mentionId], references: [id])
  assigneeId  String?
  assignee    User?      @relation(fields: [assigneeId], references: [id])
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  completedAt DateTime?

  @@index([assigneeId, status])
  @@index([clientId, status])
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  URGENT
  HIGH
  MEDIUM
  LOW
}

model DigestLog {
  id           String   @id @default(cuid())
  clientId     String
  type         String
  articleCount Int
  sentAt       DateTime @default(now())
}

model Setting {
  id          String      @id @default(cuid())
  key         String      @unique
  value       String
  type        SettingType @default(STRING)
  category    String      @default("general")
  label       String?
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

model CrisisAlert {
  id            String            @id @default(cuid())
  clientId      String
  client        Client            @relation(fields: [clientId], references: [id])
  triggerType   CrisisTriggerType
  mentionCount  Int
  severity      CrisisSeverity    @default(HIGH)
  status        CrisisStatus      @default(ACTIVE)
  resolvedAt    DateTime?
  resolvedBy    String?
  notes         String?
  notified      Boolean           @default(false)
  notifiedAt    DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([clientId, status])
  @@index([createdAt])
}

enum CrisisTriggerType {
  NEGATIVE_SPIKE
  HIGH_VOLUME
  CRITICAL_SOURCE
  MANUAL
}

enum CrisisSeverity {
  CRITICAL
  HIGH
  MEDIUM
}

enum CrisisStatus {
  ACTIVE
  MONITORING
  RESOLVED
  DISMISSED
}

model ReportLog {
  id           String   @id @default(cuid())
  clientId     String
  client       Client   @relation(fields: [clientId], references: [id])
  type         String   // "weekly" | "monthly"
  mentionCount Int
  sentAt       DateTime @default(now())

  @@index([clientId, sentAt])
}

// Sprint 6: Media Intelligence Avanzada

// Tier de fuentes por alcance
model SourceTier {
  id        String   @id @default(cuid())
  domain    String   @unique // ej: "elpais.com"
  name      String            // ej: "El País"
  tier      Int      @default(3) // 1=nacional, 2=regional, 3=digital
  reach     Int?              // alcance estimado (opcional)
  createdAt DateTime @default(now())

  @@index([tier])
}

// Cluster de temas detectados
model TopicCluster {
  id        String    @id @default(cuid())
  name      String             // ej: "Fusión empresarial"
  mentions  Mention[]
  count     Int       @default(0) // Contador de menciones
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([name])
  @@index([createdAt])
}

// Insights semanales generados por IA
model WeeklyInsight {
  id        String   @id @default(cuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id])
  weekStart DateTime
  insights  Json     // Array de recomendaciones
  sovData   Json     // Datos de SOV de esa semana
  topTopics Json     // Temas más frecuentes
  createdAt DateTime @default(now())

  @@unique([clientId, weekStart])
  @@index([clientId, weekStart])
}

// Sprint 7: Notificaciones de temas emergentes
model EmergingTopicNotification {
  id           String   @id @default(cuid())
  clientId     String
  topic        String
  mentionCount Int
  createdAt    DateTime @default(now())

  @@index([clientId, topic, createdAt])
}

// Sprint 8: Fuentes RSS expandidas
model RssSource {
  id         String     @id @default(cuid())
  name       String
  url        String     @unique
  tier       Int        @default(3) // 1=nacional, 2=estatal, 3=municipal
  type       SourceType @default(NATIONAL)
  state      String?    // NULL para nacionales
  city       String?    // NULL para estatales/nacionales
  active     Boolean    @default(true)
  lastFetch  DateTime?
  errorCount Int        @default(0)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([type, state])
  @@index([active])
}

enum SourceType {
  NATIONAL    // Medios nacionales
  STATE       // Medios estatales
  MUNICIPAL   // Medios municipales
  SPECIALIZED // Negocios, deportes, tech
}

// Sprint 8: Sistema de solicitud de fuentes
model SourceRequest {
  id          String        @id @default(cuid())
  name        String
  url         String
  state       String?
  city        String?
  requestedBy String        // userId
  status      RequestStatus @default(PENDING)
  notes       String?
  reviewedBy  String?       // adminId
  reviewedAt  DateTime?
  createdAt   DateTime      @default(now())

  @@index([status])
  @@index([requestedBy])
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  INTEGRATED
}

// Sprint 9: Sistema de múltiples destinatarios de Telegram

model TelegramRecipient {
  id        String        @id @default(cuid())
  clientId  String
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  chatId    String        // Telegram chat ID (grupo o usuario)
  type      RecipientType
  label     String?       // Etiqueta descriptiva ej: "Grupo Interno", "Juan Pérez (CMO)"
  active    Boolean       @default(true)
  addedBy   String?       // userId que lo agregó
  createdAt DateTime      @default(now())

  @@unique([clientId, chatId])
  @@index([clientId, active])
  @@index([type])
}

enum RecipientType {
  AGENCY_INTERNAL   // Grupo interno del equipo de la agencia
  CLIENT_GROUP      // Grupo compartido con el cliente
  CLIENT_INDIVIDUAL // Usuario individual del lado del cliente
}

// Sprint 10: Notificaciones In-App

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
}

enum NotificationType {
  MENTION_CRITICAL   // Mención crítica detectada
  MENTION_HIGH       // Mención de alta prioridad
  CRISIS_ALERT       // Alerta de crisis
  WEEKLY_REPORT      // Reporte semanal disponible
  EMERGING_TOPIC     // Tema emergente detectado
  SYSTEM             // Notificación del sistema
}
